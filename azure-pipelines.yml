name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  - develop
  - main
  - production

variables:
  # Your ACR name â†’ example: mycompanyacr.azurecr.io
  acrName: "guruacr.azurecr.io"

  imageName: "content-agent"
  dockerFilePath: "EY-test/Dockerfile"
  buildPlatform: "linux/amd64,linux/arm64"

  # Trivy / Aqua scan cache
  trivyCache: "$(Agent.HomeDirectory)/.cache/trivy"

# ---------
# Use your agent pool
# ---------
pool:
  vmImage: "ubuntu-latest"

steps:

# ------------------------------
# 1. Install Buildx
# ------------------------------
- script: |
    echo "Installing Docker Buildx..."
    mkdir -p ~/.docker/cli-plugins/
    curl -L https://github.com/docker/buildx/releases/latest/download/buildx-linux-amd64 -o ~/.docker/cli-plugins/docker-buildx
    chmod +x ~/.docker/cli-plugins/docker-buildx
    docker buildx version
  displayName: "Install Docker Buildx"

# ------------------------------
# 2. Login to ACR
# ------------------------------
- task: Docker@2
  displayName: "Login to ACR"
  inputs:
    command: "login"
    containerRegistry: "guru-acr"

# ------------------------------
# 3. Create Buildx Builder
# ------------------------------
- script: |
    docker buildx create --name multiarch --use
    docker buildx inspect --bootstrap
  displayName: "Create multi-arch builder"

# ------------------------------
# 4. Multi-arch Docker Build & Push
# ------------------------------
- script: |
    docker buildx build \
      --platform $(buildPlatform) \
      --file $(dockerFilePath) \
      --tag $(acrName)/$(imageName):$(Build.BuildId) \
      --tag $(acrName)/$(imageName):latest \
      --push \
      .
  displayName: "Build & Push Multi-Arch Docker Image"

# ------------------------------
# 5. Aqua Scanner (Trivy Local Mode)
# ------------------------------
- task: Docker@2
  displayName: 'Docker login (service connection)'
  inputs:
    containerRegistry: 'login aqua'
    command: 'login'

- task: aquasecScanner@4
  inputs:
    image: "$(acrName)/$(imageName):$(Build.BuildId)"
    scanType: 'local'
    containerRuntime: 'docker'
    scanner: 'registry.aquasec.com/scanner:2022.4.818'
    connection: 'guru-host'
    arguments: "--cache-dir $(trivyCache)"


# ------------------------------
# 6. Save image info for release pipeline
# ------------------------------
- script: |
    echo "{\"image\":\"$(acrName)/$(imageName):$(Build.BuildId)\"}" > $(Pipeline.Workspace)/image-tags.json
  displayName: "Create image-tags JSON"

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: "$(Pipeline.Workspace)/image-tags.json"
    artifactName: "image-tags"
